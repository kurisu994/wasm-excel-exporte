<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¿›åº¦æ¡ç¤ºä¾‹ - belobog-stellar-grid</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
        max-width: 900px;
        width: 100%;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 28px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
      }

      thead {
        background: white;
      }

      th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
      }

      td {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
      }

      .tbody-container {
        max-height: 250px;
        overflow-y: auto;
        display: block;
      }

      tbody {
        display: table;
        width: 100%;
      }

      thead,
      tbody tr {
        display: table;
        width: 100%;
        table-layout: fixed;
      }

      tr:hover {
        background-color: #f8f9fa;
      }

      .progress-container {
        width: 100%;
        background-color: #f0f0f0;
        border-radius: 10px;
        padding: 5px;
        margin: 20px 0;
        display: none;
      }

      .progress-container.show {
        display: block;
      }

      .progress-bar {
        width: 0%;
        height: 40px;
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: width 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .progress-text {
        color: white;
        font-weight: 600;
        font-size: 16px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .stat-value {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 14px;
        opacity: 0.9;
      }

      button {
        padding: 15px 30px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        transition: all 0.3s ease;
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        margin-top: 20px;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(240, 147, 251, 0.4);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      button:active:not(:disabled) {
        transform: translateY(0);
      }

      .info-box {
        background: #e7f3ff;
        border-left: 4px solid #2196f3;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
      }

      .info-box h3 {
        color: #2196f3;
        margin-bottom: 8px;
        font-size: 16px;
      }

      .info-box p {
        color: #555;
        line-height: 1.6;
        font-size: 14px;
      }

      .log {
        background: #f5f5f5;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        max-height: 200px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 13px;
      }

      .log-entry {
        padding: 5px 0;
        border-bottom: 1px solid #ddd;
      }

      .log-entry:last-child {
        border-bottom: none;
      }

      .log-time {
        color: #666;
        margin-right: 10px;
      }

      .log-message {
        color: #333;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .loading-overlay.show {
        display: flex;
      }

      .loading-content {
        background: white;
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        font-size: 18px;
        color: #333;
        margin-bottom: 10px;
      }

      .loading-progress {
        font-size: 14px;
        color: #666;
      }

      /* ç¡¬ä»¶åŠ é€Ÿä¼˜åŒ–æ»šåŠ¨æ€§èƒ½ */
      .tbody-container {
        transform: translateZ(0);
        -webkit-overflow-scrolling: touch;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“Š è¿›åº¦æ¡å¯¼å‡ºç¤ºä¾‹</h1>
      <p class="subtitle">æ¼”ç¤ºå¤§æ•°æ®é›†å¯¼å‡ºæ—¶çš„è¿›åº¦åé¦ˆåŠŸèƒ½</p>

      <div class="info-box">
        <h3>ğŸ¯ åŠŸèƒ½è¯´æ˜</h3>
        <p>
          è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº† <code>export_table()</code> å‡½æ•°çš„ä½¿ç”¨ã€‚
          å½“å¯¼å‡ºå¤§å‹è¡¨æ ¼æ—¶ï¼Œè¿›åº¦å›è°ƒå‡½æ•°ä¼šå®æ—¶æ›´æ–°è¿›åº¦æ¡ï¼Œè®©ç”¨æˆ·äº†è§£å¯¼å‡ºè¿›åº¦ã€‚
        </p>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="row-count">1000</div>
          <div class="stat-label">è¡¨æ ¼è¡Œæ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="column-count">6</div>
          <div class="stat-label">è¡¨æ ¼åˆ—æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="export-time">-</div>
          <div class="stat-label">å¯¼å‡ºè€—æ—¶</div>
        </div>
      </div>

      <table id="large-data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>äº§å“åç§°</th>
            <th>ç±»åˆ«</th>
            <th>ä»·æ ¼</th>
            <th>åº“å­˜</th>
            <th>é”€é‡</th>
          </tr>
        </thead>
      </table>
      <div class="tbody-container">
        <table style="width: 100%">
          <tbody id="table-body">
            <!-- å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
          </tbody>
        </table>
      </div>

      <div class="progress-container" id="progress-container">
        <div class="progress-bar" id="progress-bar">
          <span class="progress-text" id="progress-text">0%</span>
        </div>
      </div>

      <button id="export-btn" onclick="exportWithProgress()">ğŸš€ å¼€å§‹å¯¼å‡ºï¼ˆå¸¦è¿›åº¦æ˜¾ç¤ºï¼‰</button>

      <div class="log" id="log">
        <div class="log-entry">
          <span class="log-time">ç³»ç»Ÿ</span>
          <span class="log-message">ç­‰å¾…ç”¨æˆ·æ“ä½œ...</span>
        </div>
      </div>
    </div>

    <!-- æ•°æ®ç”ŸæˆåŠ è½½è¦†ç›–å±‚ -->
    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨ç”Ÿæˆæµ‹è¯•æ•°æ®...</div>
        <div class="loading-progress" id="loading-progress">0%</div>
      </div>
    </div>

    <script type="module">
      import init, { export_table_to_csv_batch } from "../pkg/belobog_stellar_grid.js";

      // ä½¿ç”¨ Web Worker ç”Ÿæˆå¤§é‡æµ‹è¯•æ•°æ®
      function generateTableData(rowCount = 1000) {
        return new Promise((resolve, reject) => {
          const loadingOverlay = document.getElementById("loading-overlay");
          const loadingProgress = document.getElementById("loading-progress");
          const tbody = document.getElementById("table-body");
          const exportBtn = document.getElementById("export-btn");

          // æ˜¾ç¤ºåŠ è½½è¦†ç›–å±‚
          loadingOverlay.classList.add("show");
          addLog(`ğŸ”„ å¼€å§‹ç”Ÿæˆ ${rowCount.toLocaleString()} è¡Œæ•°æ®...`);

          const worker = new Worker("./data-generator-worker.js");

          worker.onmessage = function (e) {
            const { type, rows, progress, processedCount, totalCount } = e.data;

            if (type === "progress") {
              // æ›´æ–°è¿›åº¦
              loadingProgress.textContent = `${progress}% (${processedCount.toLocaleString()} / ${totalCount.toLocaleString()})`;
            } else if (type === "complete") {
              // æ•°æ®ç”Ÿæˆå®Œæˆï¼Œå¼€å§‹åˆ†ç‰‡æ¸²æŸ“
              tbody.innerHTML = "";

              // æ¸²æŸ“é…ç½®
              const totalRows = rows.length;
              const batchSize = 500; // æ¯æ‰¹æ¸²æŸ“ 500 è¡Œ
              let currentIndex = 0;

              addLog(`âš¡ï¸ æ•°æ®ç”Ÿæˆå®Œæ¯•ï¼Œå¼€å§‹æ¸²æŸ“ ${totalRows.toLocaleString()} è¡Œæ•°æ®...`);

              const startTime = performance.now(); // è®°å½•æ¸²æŸ“å¼€å§‹æ—¶é—´

              function renderBatch() {
                const fragment = document.createDocumentFragment();
                const endIndex = Math.min(currentIndex + batchSize, totalRows);

                for (let i = currentIndex; i < endIndex; i++) {
                  const rowData = rows[i];
                  const row = document.createElement("tr");

                  // ä½¿ç”¨ innerHTML æ„å»ºè¡Œå†…å®¹
                  row.innerHTML = `
                    <td>${rowData.id}</td>
                    <td>${rowData.product}</td>
                    <td><span class="badge badge-${
                      rowData.category === "ç”µå­äº§å“"
                        ? "primary"
                        : rowData.category === "å®¶å±…ç”¨å“"
                        ? "success"
                        : "warning"
                    }">${rowData.category}</span></td>
                    <td>${rowData.price}</td>
                    <td>${rowData.stock}</td>
                    <td>${rowData.sales}</td>
                  `;

                  fragment.appendChild(row);
                }

                tbody.appendChild(fragment);
                currentIndex = endIndex;

                // æ›´æ–°è¿›åº¦
                const progress = Math.round((currentIndex / totalRows) * 100);
                loadingProgress.textContent = `æ¸²æŸ“ä¸­... ${progress}% (${currentIndex.toLocaleString()} / ${totalRows.toLocaleString()})`;

                if (currentIndex < totalRows) {
                  // ç»™æµè§ˆå™¨æ›´å¤šæ—¶é—´å¤„ç†ï¼Œä½¿ç”¨ setTimeout æ›¿ä»£ requestAnimationFrame
                  setTimeout(renderBatch, 0);
                } else {
                  // æ¸²æŸ“å®Œæˆï¼Œå»¶è¿Ÿä¸€å¸§åå…³é—­åŠ è½½æç¤º
                  requestAnimationFrame(() => {
                    const endTime = performance.now();
                    const duration = ((endTime - startTime) / 1000).toFixed(2);

                    loadingOverlay.classList.remove("show");
                    addLog(`âœ… æ¸²æŸ“å®Œæˆï¼æ€»è€—æ—¶: ${duration}ç§’`);
                    document.getElementById("row-count").textContent = totalRows.toLocaleString();
                    exportBtn.disabled = false;
                    worker.terminate();
                    resolve();
                  });
                }
              }

              // å¼€å§‹ç¬¬ä¸€æ‰¹æ¸²æŸ“
              requestAnimationFrame(renderBatch);
            }
          };

          worker.onerror = function (error) {
            loadingOverlay.classList.remove("show");
            addLog("âŒ æ•°æ®ç”Ÿæˆå¤±è´¥: " + error.message);
            worker.terminate();
            reject(error);
          };

          // å¯åŠ¨ Worker
          worker.postMessage({ rowCount });
        });
      }

      // æ·»åŠ æ—¥å¿—
      function addLog(message, type = "info") {
        const log = document.getElementById("log");
        const entry = document.createElement("div");
        entry.className = "log-entry";

        const time = new Date().toLocaleTimeString("zh-CN");
        entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-message">${message}</span>
            `;

        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
      }

      // åˆå§‹åŒ– WASM æ¨¡å—
      let wasmInitialized = false;

      async function initWasm() {
        if (!wasmInitialized) {
          try {
            await init();
            wasmInitialized = true;
            addLog("âœ… WASM æ¨¡å—åˆå§‹åŒ–æˆåŠŸ");
            console.log("âœ… WASM æ¨¡å—åˆå§‹åŒ–æˆåŠŸ");
          } catch (error) {
            addLog("âŒ WASM æ¨¡å—åˆå§‹åŒ–å¤±è´¥: " + error);
            throw error;
          }
        }
      }

      // å¯¼å‡ºå‡½æ•° - å¸¦è¿›åº¦æ˜¾ç¤º
      window.exportWithProgress = async function () {
        try {
          await initWasm();

          const btn = document.getElementById("export-btn");
          const progressContainer = document.getElementById("progress-container");
          const progressBar = document.getElementById("progress-bar");
          const progressText = document.getElementById("progress-text");
          const exportTimeElement = document.getElementById("export-time");

          // ç¦ç”¨æŒ‰é’®
          btn.disabled = true;
          btn.textContent = "â³ æ­£åœ¨å¯¼å‡º...";

          // æ˜¾ç¤ºè¿›åº¦æ¡
          progressContainer.classList.add("show");
          progressBar.style.width = "0%";
          progressText.textContent = "0%";

          addLog("ğŸš€ å¼€å§‹å¯¼å‡ºæ•°æ®...");

          const startTime = performance.now();

          // è¿›åº¦å›è°ƒå‡½æ•°
          let lastProgress = 0;
          const progressCallback = (progress) => {
            const roundedProgress = Math.round(progress);
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${roundedProgress}%`;

            // æ¯ 20% è®°å½•ä¸€æ¬¡æ—¥å¿—
            if (roundedProgress % 20 === 0 && roundedProgress !== lastProgress) {
              addLog(`ğŸ“Š å¯¼å‡ºè¿›åº¦: ${roundedProgress}%`);
              lastProgress = roundedProgress;
            }
          };

          // æ‰§è¡Œå¯¼å‡º - ä½¿ç”¨åˆ†æ‰¹å¼‚æ­¥å¤„ç†ï¼ˆDOMè¯»å–æ¨¡å¼ï¼‰
          const today = new Date().toISOString().split("T")[0];
          const filename = `äº§å“æ•°æ®_${today}.csv`;

          await export_table_to_csv_batch(
            "large-data-table",
            "table-body", // ä¼ å…¥ tbody IDï¼Œæ”¯æŒåˆ†ç¦»çš„è¡¨æ ¼ç»“æ„
            filename,
            1000, // æ¯æ‰¹å¤„ç† 1000 è¡Œ
            progressCallback
          );

          const endTime = performance.now();
          const duration = ((endTime - startTime) / 1000).toFixed(2);

          exportTimeElement.textContent = `${duration}s`;

          addLog(`âœ… å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å: ${filename}`);
          addLog(`â±ï¸ è€—æ—¶: ${duration} ç§’`);

          // å»¶è¿Ÿéšè—è¿›åº¦æ¡
          setTimeout(() => {
            progressContainer.classList.remove("show");
            btn.disabled = false;
            btn.textContent = "ğŸš€ å¼€å§‹å¯¼å‡ºï¼ˆå¸¦è¿›åº¦æ˜¾ç¤ºï¼‰";
          }, 2000);
        } catch (error) {
          addLog("âŒ å¯¼å‡ºå¤±è´¥: " + error);
          console.error("âŒ å¯¼å‡ºå¤±è´¥:", error);

          const btn = document.getElementById("export-btn");
          const progressContainer = document.getElementById("progress-container");

          btn.disabled = false;
          btn.textContent = "ğŸš€ å¼€å§‹å¯¼å‡ºï¼ˆå¸¦è¿›åº¦æ˜¾ç¤ºï¼‰";
          progressContainer.classList.remove("show");
        }
      };

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.addEventListener("DOMContentLoaded", async () => {
        try {
          // å…ˆåˆå§‹åŒ– WASMï¼ˆå¾ˆå¿«ï¼‰
          await initWasm();

          // ç„¶åå¼‚æ­¥ç”Ÿæˆæ•°æ®ï¼ˆä½¿ç”¨ Workerï¼Œä¸é˜»å¡ï¼‰
          // é»˜è®¤ç”Ÿæˆ 10000 è¡Œ
          await generateTableData(10_000);
        } catch (error) {
          console.error("åˆå§‹åŒ–å¤±è´¥:", error);
          addLog("âŒ åˆå§‹åŒ–å¤±è´¥: " + error);
        }
      });
    </script>
  </body>
</html>
