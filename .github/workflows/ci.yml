name: CI

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£… Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: æ£€æŸ¥ä»£ç æ ¼å¼
        run: cargo fmt -- --check

      - name: è¿è¡Œ Clippy
        run: cargo clippy -- -D warnings

      - name: è¿è¡Œæµ‹è¯•
        run: cargo test --lib --verbose

  # WebAssembly æ„å»º
  build-wasm:
    name: WebAssembly æ„å»º
    runs-on: ubuntu-latest
    needs: check

    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£… Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: å®‰è£… wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: æ„å»ºé¡¹ç›®
        run: cargo check --target wasm32-unknown-unknown --verbose

      - name: æ„å»º WebAssembly åŒ…
        run: wasm-pack build --target web --release

      - name: æ£€æŸ¥åŒ…å¤§å°
        run: |
          echo "WebAssembly æ–‡ä»¶å¤§å°:"
          ls -lh pkg/excel_exporter_bg.wasm

          PACKAGE_SIZE=$(stat -c%s pkg/excel_exporter_bg.wasm)
          echo "åŒ…å¤§å°: ${PACKAGE_SIZE} bytes"

          if [ $PACKAGE_SIZE -gt 100000 ]; then
            echo "âš ï¸ è­¦å‘Š: åŒ…å¤§å°è¶…è¿‡ 100KB"
          else
            echo "âœ… åŒ…å¤§å°åˆç†"
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: wasm-package
          path: pkg/
          retention-days: 30

  # æµè§ˆå™¨æµ‹è¯•
  browser-test:
    name: æµè§ˆå™¨æµ‹è¯•
    runs-on: ubuntu-latest
    needs: build-wasm

    steps:
      - uses: actions/checkout@v4

      - name: ä¸‹è½½ WebAssembly åŒ…
        uses: actions/download-artifact@v4
        with:
          name: wasm-package
          path: pkg/

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: åˆ›å»ºæµ‹è¯•é¡µé¢
        run: |
          mkdir -p browser-test
          cat > browser-test/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>WebAssembly æµ‹è¯•</title>
          </head>
          <body>
            <h1>WebAssembly åŠŸèƒ½æµ‹è¯•</h1>
            <table id="test-table">
              <tr><td>æµ‹è¯•æ•°æ®1</td><td>æµ‹è¯•æ•°æ®2</td></tr>
              <tr><td>æµ‹è¯•æ•°æ®3</td><td>æµ‹è¯•æ•°æ®4</td></tr>
            </table>
            <button onclick="runTest()">è¿è¡Œæµ‹è¯•</button>
            <div id="result"></div>

            <script type="module">
              import init, { export_table_to_csv } from './pkg/excel_exporter.js';

              async function runTest() {
                try {
                  await init();
                  await export_table_to_csv('test-table', 'test.csv');
                  document.getElementById('result').innerHTML =
                    '<div style="color: green;">âœ… æµ‹è¯•æˆåŠŸ</div>';
                } catch (error) {
                  document.getElementById('result').innerHTML =
                    '<div style="color: red;">âŒ æµ‹è¯•å¤±è´¥: ' + error.message + '</div>';
                }
              }
            </script>
          </body>
          </html>
          EOF

      - name: åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•
        run: |
          # å®‰è£… Puppeteer è¿›è¡Œæµè§ˆå™¨æµ‹è¯•
          npm install puppeteer

          # è¿è¡Œæµ‹è¯•
          node -e "
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');

          (async () => {
            const browser = await puppeteer.launch({
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();

            // ç›‘å¬æ§åˆ¶å°æ¶ˆæ¯
            page.on('console', msg => {
              console.log('Browser console:', msg.text());
            });

            const testPage = 'file://' + path.resolve(__dirname, 'browser-test/index.html');
            await page.goto(testPage);

            // ç­‰å¾…é¡µé¢åŠ è½½
            await page.waitForSelector('h1');

            // ç‚¹å‡»æµ‹è¯•æŒ‰é’®
            await page.click('button');

            // ç­‰å¾…æµ‹è¯•ç»“æœ
            await page.waitForSelector('#result div', { timeout: 5000 });

            const result = await page.$eval('#result', el => el.textContent);
            console.log('Test result:', result);

            if (result.includes('æµ‹è¯•æˆåŠŸ')) {
              console.log('âœ… WebAssembly æµ‹è¯•é€šè¿‡');
              process.exit(0);
            } else {
              console.log('âŒ WebAssembly æµ‹è¯•å¤±è´¥');
              process.exit(1);
            }

            await browser.close();
          })();
          "

  # å‘å¸ƒå‡†å¤‡
  release-prep:
    name: å‘å¸ƒå‡†å¤‡
    runs-on: ubuntu-latest
    needs: [check, build-wasm]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: ä¸‹è½½ WebAssembly åŒ…
        uses: actions/download-artifact@v4
        with:
          name: wasm-package
          path: pkg/

      - name: æ£€æŸ¥ç‰ˆæœ¬ä¸€è‡´æ€§
        run: |
          VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\/v//')
          echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"

          # æ£€æŸ¥ Cargo.toml ç‰ˆæœ¬
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | cut -d '"' -f 2)
          if [ "$VERSION" != "$CARGO_VERSION" ]; then
            echo "âŒ ç‰ˆæœ¬ä¸ä¸€è‡´: Git=$VERSION, Cargo=$CARGO_VERSION"
            exit 1
          fi

          echo "âœ… ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        run: |
          # æ›´æ–° package.json ç‰ˆæœ¬
          VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\/v//')
          npm version $VERSION --no-git-tag-version

          # è¿è¡Œå®Œæ•´æµ‹è¯•
          npm test || true  # å…è®¸å¤±è´¥ï¼Œå› ä¸ºå¯èƒ½éœ€è¦çœŸå®æµè§ˆå™¨

          echo "ğŸ“¦ å‘å¸ƒåŒ…å‡†å¤‡å®Œæˆ"

      - name: ä¸Šä¼ å‘å¸ƒäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: pkg/
          retention-days: 90
